<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="websiteTitle">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-900">
    <div class="form-container" style="max-width: 500px;">
        <div class="flex justify-between items-center mb-6">
            <h2 class="form-title">üí∏ ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö</h2>
            <button id="backToStaffMenuBtn" class="button-secondary text-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π Staff</button>
        </div>
        
        <form id="fineForm">
            <div class="mb-4">
                <label for="memberNameSelect" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô:</label>
                <select id="memberNameSelect" class="select-field">
                    <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="fineItemSelect" class="form-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö:</label>
                <select id="fineItemSelect" class="select-field">
                    <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="fineAmount" class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö:</label>
                <input type="text" id="fineAmount" class="input-field" readonly>
            </div>
            <div class="mb-4">
                <label for="fineReason" class="form-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ):</label>
                <textarea id="fineReason" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" class="textarea-field"></textarea>
            </div>
            <button type="button" id="submitFineBtn" class="button-primary w-full">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö</button>
            <div id="messageBox" class="message-box mt-4"></div>
        </form>
    </div>
    
    <footer class="mt-8 py-4 px-6 text-center text-gray-300">
        <p>¬© <span id="copyrightYear"></span> <span id="copyrightName"></span></p>
    </footer>

    <script src="js/shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!user || !user.group || !checkPagePermission(user.group, 'fine_form.html')) {
                window.location.href = 'login.html';
                return;
            }
            applyThemeSettings();
            let settings = getSettings();
            
            const memberNameSelect = document.getElementById('memberNameSelect');
            const fineItemSelect = document.getElementById('fineItemSelect');
            const fineAmountInput = document.getElementById('fineAmount');
            const fineReasonInput = document.getElementById('fineReason');
            const submitFineBtn = document.getElementById('submitFineBtn');
            const messageBox = document.getElementById('messageBox');

            // Populate member names from house list
            function populateMemberNames() {
                const houseMembers = gethouselist(); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô gethouselist()
                memberNameSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</option>';
                houseMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name;
                    memberNameSelect.appendChild(option);
                });
            }

            // Populate fine items from settings
            function populateFineItems() {
                const fineList = getFineList();
                fineItemSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö</option>';
                fineList.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = `${item.name} (‡∏ø${item.amount})`;
                    fineItemSelect.appendChild(option);
                });
            }

            // Update fine amount based on selected item
            fineItemSelect.addEventListener('change', () => {
                const selectedFineName = fineItemSelect.value;
                const fineDetails = getFineDetails(selectedFineName);
                if (fineDetails) {
                    fineAmountInput.value = fineDetails.amount;
                } else {
                    fineAmountInput.value = '';
                }
            });

            submitFineBtn.addEventListener('click', async () => {
                const memberName = memberNameSelect.value;
                const fineItemName = fineItemSelect.value;
                const fineAmount = fineAmountInput.value;
                const fineReason = fineReasonInput.value.trim();

                if (!memberName || !fineItemName || !fineAmount) {
                    showMessage(messageBox, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö', true);
                    return;
                }
                
                const fineData = {
                    memberName: memberName,
                    fineItem: fineItemName,
                    amount: fineAmount,
                    reason: fineReason,
                    timestamp: new Date().getTime(),
                    staffUser: user.username
                };

                let fineHistory = getFineHistory();
                fineHistory.push(fineData);
                saveFineHistory(fineHistory);

                const webhookUrl = settings.webhookUrl;
                if (!webhookUrl) { return showMessage(messageBox, '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Webhook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö', true); }

                showMessage(messageBox, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö...', false);

                const payload = {
                    username: settings.websiteName || "‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö",
                    avatar_url: settings.logoImageUrl || "",
                    embeds: [{
                        title: "üí∏ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà",
                        description: `**‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:** ${fineData.memberName}\n**‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:** ${fineData.fineItem}\n**‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:** ‡∏ø${fineData.amount}`,
                        color: parseInt(settings.themeAccentColor.replace('#', ''), 16),
                        fields: [
                            { name: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö", value: fineData.memberName, inline: true },
                            { name: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö", value: fineData.fineItem, inline: true },
                            { name: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", value: `‡∏ø${fineData.amount}`, inline: true },
                            { name: "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°", value: fineData.reason || "‡πÑ‡∏°‡πà‡∏°‡∏µ", inline: false }
                        ],
                        footer: { text: `‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏î‡∏¢: ${fineData.staffUser}` },
                        timestamp: new Date().toISOString()
                    }]
                };

                try {
                    await sendDiscordWebhook(webhookUrl, payload);
                    showMessage(messageBox, '‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', false);
                    document.getElementById('fineForm').reset();
                    fineAmountInput.value = '';
                } catch (error) {
                    console.error('Failed to send webhook:', error);
                    showMessage(messageBox, '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏£‡∏±‡∏ö', true);
                }
            });

            document.getElementById('backToStaffMenuBtn').addEventListener('click', () => {
                window.location.href = 'staff.html';
            });

            populateMemberNames();
            populateFineItems();
        });
    </script>
</body>
</html>