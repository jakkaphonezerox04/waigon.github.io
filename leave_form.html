<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="websiteTitle">‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-900">
    <div class="form-container">
        <div class="flex justify-between items-center mb-6">
            <h2 class="form-title">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤</h2>
            <button id="backToMenuBtn" class="button-secondary text-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π</button>
        </div>
        
        <form id="leaveRequestForm">
            <div class="mb-4"><label for="name" class="form-label"><span class="icon user-icon"></span>‡∏ä‡∏∑‡πà‡∏≠:</label><input type="text" id="name" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="input-field"></div>
            <div class="mb-4"><label for="houseName" class="form-label"><span class="icon user-icon"></span>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô:</label><input type="text" id="houseName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="input-field"></div>
            <div class="mb-4"><label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤:</label><div id="leaveTypeCheckboxes" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div><label for="startDate" class="form-label"><span class="icon calendar-icon"></span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤:</label><input type="date" id="startDate" class="input-field"></div>
                <div><label for="endDate" class="form-label"><span class="icon calendar-icon"></span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label><input type="date" id="endDate" class="input-field"></div>
            </div>
            <div class="mb-4"><label for="reason" class="form-label"><span class="icon file-icon"></span>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</label><textarea id="reason" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." class="textarea-field"></textarea></div>
            <button type="button" id="submitLeaveBtn" class="button-primary w-full">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</button>
            <div id="messageBox" class="message-box mt-4"></div>
        </form>
    </div>
    
    <script src="js/shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!user || !user.group || !checkPagePermission(user.group, 'leave_form.html')) {
                window.location.href = 'login.html';
                return;
            }
            applyThemeSettings();
            let settings = getSettings();
            
            document.getElementById('name').value = user.username;
            const leaveTypeCheckboxesDiv = document.getElementById('leaveTypeCheckboxes');
            if (settings.leaveTypes) { settings.leaveTypes.forEach(type => { const l = document.createElement('label'); l.className = 'checkbox-label'; l.innerHTML = `<input type="checkbox" name="leaveType" value="${type}"> ${type}`; leaveTypeCheckboxesDiv.appendChild(l); }); }

            document.getElementById('backToMenuBtn').addEventListener('click', () => { window.location.href = 'user.html'; });
            
            document.getElementById('submitLeaveBtn').addEventListener('click', async () => {
                const leaveData = { name: document.getElementById('name').value.trim(), houseName: document.getElementById('houseName').value.trim(), leaveTypes: Array.from(document.querySelectorAll('input[name="leaveType"]:checked')).map(cb => cb.value), startDate: document.getElementById('startDate').value, endDate: document.getElementById('endDate').value, reason: document.getElementById('reason').value.trim(), timestamp: new Date().getTime(), userId: user.username };
                if (!leaveData.name || leaveData.leaveTypes.length === 0 || !leaveData.startDate || !leaveData.endDate || !leaveData.reason) { return showMessage(document.getElementById('messageBox'), '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true); }
                
                let leaveRequests = getLeaveRequests();
                leaveRequests.push(leaveData);
                saveLeaveRequests(leaveRequests);
                
                const fullName = leaveData.houseName ? `[${leaveData.houseName}] ${leaveData.name}` : leaveData.name;
                const description = `**‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠:** ${fullName}\n**‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÇ‡∏î‡∏¢‡∏¢‡πà‡∏≠:** ${leaveData.reason}`;

                const payload = {
                    username: settings.websiteName || "‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤",
                    avatar_url: settings.logoImageUrl || "",
                    embeds: [{
                        title: "üìù ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà",
                        description: description,
                        color: parseInt(settings.themeAccentColor.replace('#', ''), 16),
                        fields: [
                            { name: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤", value: leaveData.leaveTypes.join(', '), inline: true },
                            { name: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤", value: leaveData.startDate, inline: true },
                            { name: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î", value: leaveData.endDate, inline: true },
                            { name: "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•", value: leaveData.reason, inline: false }
                        ],
                        footer: { text: `‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢: ${user.username}` },
                        timestamp: new Date().toISOString()
                    }]
                };
                
                if (settings.webhookUrl) {
                    await sendDiscordWebhook(settings.webhookUrl, payload);
                } else {
                    console.warn("Leave Request Webhook URL is not set in admin settings.");
                }
                
                showMessage(document.getElementById('messageBox'), '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', false);
                document.getElementById('leaveRequestForm').reset();
            });
        });
    </script>
</body>
</html>